---
apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: postgres-immich
  namespace: databases
  annotations:
    cnpg.io/skipEmptyWalArchiveCheck: "enabled"
spec:
  instances: 3

  # renovate: datasource=docker depName=ghcr.io/cloudnative-pg/postgresql
  imageName: ghcr.io/cloudnative-pg/postgresql:18.1-standard-trixie@sha256:441cda9cd1b2ba50d45245f6498ec39a0ad97a7532e9eb159004a1d1cc856749

  primaryUpdateStrategy: unsupervised

  postgresql:
    parameters:
      max_connections: "400"
      shared_buffers: 512MB
      pg_stat_statements.max: "10000"
      pg_stat_statements.track: all
      timezone: "Europe/Berlin"
    extensions:
      - name: vchord
        image:
          reference: ghcr.io/tensorchord/vchord-scratch:pg18-v0.5.3
          dynamic_library_path:
            - /usr/lib/postgresql/18/lib/
          extension_control_path:
            - /usr/share/postgresql/18/
    shared_preload_libraries: ["vchord.so"]

  bootstrap:
    initdb:
      database: immich        # Name der Datenbank
      owner: immich          # Benutzer, der die DB besitzt
      secret:
        name: immich-db-secret  # Secret mit Zugangsdaten f√ºr den User

  storage:
    size: 100Gi
    storageClass: ceph-rbd

  enableSuperuserAccess: true
  superuserSecret:
    name: cloudnative-pg

  resources:
    requests:
      cpu: 500m
    limits:
      hugepages-2Mi: 2Gi
      memory: 4Gi

  monitoring:
    enablePodMonitor: true

  plugins:
    - name: barman-cloud.cloudnative-pg.io
      isWALArchiver: true
      parameters: &parameters
        barmanObjectName: immich-backup
        serverName: postgres-immich

  #bootstrap:
  #  recovery:
  #    source: postgres-server-14

  # backup:
  #   retentionPolicy: 30d
  #   barmanObjectStore:
  #     wal:
  #       compression: bzip2
  #       maxParallel: 8
  #     destinationPath: s3://postgresql/
  #     endpointURL: http://minio.storage.svc.cluster.local:9000
  #     serverName: postgres-immich-backup
  #     s3Credentials:
  #       accessKeyId:
  #         name: cloudnative-pg
  #         key: MINIO_ACCESS_KEY
  #       secretAccessKey:
  #         name: cloudnative-pg
  #         key: MINIO_SECRET_KEY

  #externalClusters:
  #  - name: postgres-server-14
  #    barmanObjectStore:
  #      wal:
  #        compression: bzip2
  #        maxParallel: 8
  #      destinationPath: s3://postgresql/
  #      endpointURL: http://minio.storage.svc.cluster.local:9000
  #      s3Credentials:
  #        accessKeyId:
  #          name: cloudnative-pg
  #          key: MINIO_ACCESS_KEY
  #        secretAccessKey:
  #          name: cloudnative-pg
  #          key: MINIO_SECRET_KEY
